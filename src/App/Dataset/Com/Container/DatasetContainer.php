<?php

namespace Nemundo\App\Dataset\Com\Container;

use Nemundo\Admin\Com\Button\AdminSiteButton;
use Nemundo\Admin\Com\Form\AdminSearchForm;
use Nemundo\Admin\Com\Item\AdminItemContainer;
use Nemundo\Admin\Com\Item\AdminItemText;
use Nemundo\Admin\Com\Item\AdminItemTitle;
use Nemundo\Admin\Com\Table\AdminLabelValueTable;
use Nemundo\App\Dataset\Com\ListBox\CategoryListBox;
use Nemundo\App\Dataset\Com\ListBox\OrganisationListBox;
use Nemundo\App\Dataset\Reader\DatasetDataReader;
use Nemundo\App\Dataset\Type\AbstractDataset;
use Nemundo\Html\Block\Div;


class DatasetContainer extends Div
{

    public function getContent()
    {

        $search = new AdminSearchForm($this);

        $category = new CategoryListBox($search);
        $category->submitOnChange = true;
        $category->searchMode = true;

        $organisation = new OrganisationListBox($search);
        $organisation->submitOnChange = true;
        $organisation->searchMode = true;


        $reader = new DatasetDataReader();

        if ($category->hasValue()) {
            $reader->filter->andEqual($reader->model->categoryId, $category->getValue());
        }

        if ($organisation->hasValue()) {
            $reader->filter->andEqual($reader->model->organisationId, $organisation->getValue());
        }


        foreach ($reader->getData() as $datasetRow) {

            $container = new AdminItemContainer($this);

            $title = new AdminItemTitle($container);
            $title->content = $datasetRow->dataset;

            $description = new AdminItemText($container);
            $description->content = $datasetRow->description;

            $table = new AdminLabelValueTable($container);
            $table->addLabelValue('Licence',$datasetRow->licence);
            $table->addLabelHyperlink('Url',$datasetRow->url);
            $table->addLabelValue('Category',$datasetRow->category->category);
            $table->addLabelValue('Organisation',$datasetRow->organisation->organisation);


            $className = $datasetRow->phpClass;

            if (class_exists($className)) {

                /** @var AbstractDataset $dataset */
                $dataset = new $className();
                $dataset->site->title = 'Data';

                $btn = new AdminSiteButton($container);
                $btn->content = 'Data';
                $btn->site = $dataset->site;


            }

            /*$btn = new AdminSiteButton($container);
            $btn->content='Information';
            $btn->site=clone(ParametricSite::$site);

            $btn = new AdminSiteButton($container);
            $btn->content='Data';
            $btn->site=clone(ParametricSite::$site);*/

        }

        return parent::getContent(); // TODO: Change the autogenerated stub
    }


}